/*! jQuery Session Timeout - v0.1.0 - 2012-12-04
* https://github.com/asabaylus/jQuery-sessionTimeout
* Copyright (c) 2012 Asa Baylus; Licensed MIT, GPL */
(function(a){var b={},c,d,e={},f=[],g=new Date,h="sessionTimeout_"+g.getTime(),i,j,k,l,m="0.0.1",n,o,p,q,r=!1,s,t,u={autoping:!1,enableidletimer:!0,timeout:3e5,resource:"spacer.gif",promptfor:1e4,beforetimeout:a.noop,ontimeout:a.noop,pollactivity:1e3};a.fn.sessionTimeout=function(c,d){b={_init:function(){r=a.isFunction(a.idleTimer);if(r){j=a(document),a.idleTimer(Number(d.pollactivity));if(d.pollactivity>d.timeout-d.promptfor)return a.error("The configuration pollactivity is too long: polling must happen prior to the beforetimeout callback."),!1}b._startCountdown.apply(),n=new Date,a(document).trigger("create.sessionTimeout",[m,g,n-g])},_startCountdown:function(){s=new Date,t=s.getTime(),d.autoping===!0?q=window.setTimeout(function(){b.ping.apply()},d.timeout):r&&d.enableidletimer?(clearTimeout(q),clearTimeout(k),q=window.setTimeout(function(){b._beforeTimeout.apply()},d.timeout-d.promptfor),j.one("active.idleTimer",function(){b._stopCountdown.apply(),b.ping.apply(),k=setTimeout(function(){b.ping.apply()},d.timeout)}),j.one("idle.idleTimer",function(){clearTimeout(k)}),a(document).bind("expired.sessionTimeout",function(){j.unbind("active.idleTimer"),j.unbind("idle.idleTimer")}),typeof a.data(document,"idleTimer")=="undefined"&&j.trigger("idle.idleTimer")):(clearTimeout(q),q=window.setTimeout(function(){b._beforeTimeout.apply()},d.timeout-d.promptfor)),a(document).trigger("startCountdown.sessionTimeout")},_stopCountdown:function(){window.clearTimeout(o),window.clearTimeout(q),window.clearTimeout(k)},_beforeTimeout:function(){if(a.isFunction(d.beforetimeout)){var c=new Date;b._logEvent("$.fn.sessionTimeout status: beforeTimeout triggered @"+c.toTimeString()),d.beforetimeout.call(this),a(document).trigger("prompt.sessionTimeout")}else a.error("The jQuery.sessionTimeout beforetimeout parameter is expecting a function");o=window.setTimeout(function(){if(a.isFunction(d.ontimeout))d.ontimeout.call(this);else return a.error("The jQuery.sessionTimeout ontimeout parameter is expecting a function"),!1;b._stopCountdown.apply();var c=new Date;a(document).trigger("expired.sessionTimeout")},d.promptfor)},_fetch:function(){var b=new Date,c=b.getTime(),e=/^(.+)\.([^\.]*)?$/,f=/^jpg|jpeg|png|gif|bmp$/,g=d.resource.match(e),j=g[2],k=f.test(j);typeof i=="undefined"?k?a("body").append("<img id='"+h+"' src='"+d.resource+"?tstamp="+c+'\' style=\'position: "absolute", height: "1px", width: "1px"\' alt=\'web page session management helper\'>'):a("body").append("<iframe id='"+h+"' src='"+d.resource+"?tstamp="+c+'\' style=\'position: "absolute", height: "1px", width: "1px", display: "none"\' alt=\'web page session management helper\'></iframe>'):i.attr("src",d.resource+"?timestamp="+c),i=a("#"+h)},ping:function(){var c=new Date,d=c.getTime();if(r&&a.data(document,"idleTimer")==="idle")return!1;b._stopCountdown.apply(),b._fetch.apply(),b._logEvent("$.fn.sessionTimeout status: session restarted @ "+c.toTimeString()),a(document).trigger("ping.sessionTimeout"),r&&b._startCountdown.apply()},duration:function(a){return a||b._logEvent("$.fn.sessionTimeout status: duration "+d.timeout),Number(d.timeout)},elapsed:function(){var a=new Date-n;return b._logEvent("$.fn.sessionTimeout status: elapsed "+a+" ms"),a},remaining:function(a){var c=new Date,e=c.getTime(),f=t,g=Number(d.timeout),h=g+(f-e)>0?g+(f-e):0;return a||b._logEvent("$.fn.sessionTimeout status: remaining "+h+" ms"),h},destroy:function(){typeof n!="undefined"?(typeof i!="undefined"&&i.remove(),b._stopCountdown.apply(),r&&j.unbind(".idleTimer"),o=null,p=null,q=null,n=undefined,b._logEvent("$.fn.sessionTimeout status: destroy"),a(document).trigger("destroy.sessionTimeout"),a(document).unbind(".sessionTimeout"),r&&j.idleTimer("destroy"),f.length=0):a.error("Could not destroy, initialize the plugin before calling destroy.")},_logEvent:function(b){f.push(b),a(document).trigger("eventLogged.sessionTimeout")},printLog:function(){return f}},b[d]||(d=a.extend(d,c)),d=a.extend(u,d);if(b[c])return b[c].apply(this,Array.prototype.slice.call(arguments,1));if(typeof c=="object"||!c)return b._init.apply(this,arguments);a.error("Method "+c+" does not exist on jQuery.sessionTimeout")}})(jQuery);